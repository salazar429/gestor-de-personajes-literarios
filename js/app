// Detectar la ruta base automáticamente
const BASE_PATH = window.location.hostname.includes('github.io') 
    ? '/gestor-de-personajes-literarios' 
    : '';

// Variables globales
let obraAEliminar = null;
let personajeAEliminar = null;
let relacionAEliminar = null;

document.addEventListener('DOMContentLoaded', async () => {
    await inicializarApp();
});

async function inicializarApp() {
    try {
        await abrirDB();
        await cargarObras();
        configurarEventosGlobales();
    } catch (error) {
        console.error('Error al inicializar la app:', error);
        mostrarError('Error al inicializar la aplicación');
    }
}

function configurarEventosGlobales() {
    // Cerrar modales con Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            cerrarTodosModales();
        }
    });
    
    // Cerrar modales haciendo clic fuera
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            cerrarTodosModales();
        }
    });
    
    // Botón de confirmar eliminación
    document.getElementById('confirmar-eliminar').addEventListener('click', async () => {
        if (obraAEliminar !== null) {
            await eliminarObra(obraAEliminar);
            obraAEliminar = null;
            cerrarModalConfirmar();
            await cargarObras();
        } else if (personajeAEliminar !== null) {
            await eliminarPersonaje(personajeAEliminar);
            personajeAEliminar = null;
            cerrarModalConfirmar();
            if (typeof cargarPersonajesDeObra === 'function' && window.obraActual) {
                await cargarPersonajesDeObra(window.obraActual.id);
            }
        } else if (relacionAEliminar !== null) {
            await eliminarRelacion(relacionAEliminar);
            relacionAEliminar = null;
            cerrarModalConfirmar();
            if (typeof renderizarArbolGenealogico === 'function') {
                renderizarArbolGenealogico();
            }
        }
    });
}

function cerrarTodosModales() {
    document.getElementById('modal-obra').style.display = 'none';
    document.getElementById('modal-personaje').style.display = 'none';
    document.getElementById('modal-relacion').style.display = 'none';
    document.getElementById('modal-confirmar').style.display = 'none';
}

// Función para abrir modal de confirmación
function abrirModalConfirmar(tipo, id) {
    if (tipo === 'obra') {
        obraAEliminar = id;
        personajeAEliminar = null;
        relacionAEliminar = null;
    } else if (tipo === 'personaje') {
        personajeAEliminar = id;
        obraAEliminar = null;
        relacionAEliminar = null;
    } else if (tipo === 'relacion') {
        relacionAEliminar = id;
        obraAEliminar = null;
        personajeAEliminar = null;
    }
    document.getElementById('modal-confirmar').style.display = 'block';
}

function cerrarModalConfirmar() {
    document.getElementById('modal-confirmar').style.display = 'none';
    obraAEliminar = null;
    personajeAEliminar = null;
    relacionAEliminar = null;
}

// Función para escapar HTML
function escapeHTML(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Función para mostrar errores
function mostrarError(mensaje) {
    const toast = document.createElement('div');
    toast.className = 'toast-error';
    toast.textContent = mensaje;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #dc3545;
        color: white;
        padding: 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Función para mostrar éxito
function mostrarExito(mensaje) {
    const toast = document.createElement('div');
    toast.className = 'toast-exito';
    toast.textContent = mensaje;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 2000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Añadir estilos para animaciones
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .toast-error, .toast-exito {
        transition: opacity 0.3s ease;
    }
`;
document.head.appendChild(style);
